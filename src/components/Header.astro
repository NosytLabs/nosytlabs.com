---
import LogoPrimary from './brand/LogoPrimary.astro';
import ThemeToggle from './ThemeToggle.tsx';
import Button from './ui/Button.astro';
import Icon from './ui/Icon.astro';

// Navigation links with dropdown support
const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/about', label: 'About' },
  { 
    href: '/services', 
    label: 'Services',
    dropdown: [
      { href: '/services/web-development', label: 'Web Development', icon: 'code' },
      { href: '/services/consulting', label: 'Consulting', icon: 'users' },
      { href: '/services/support', label: 'Support', icon: 'headphones' }
    ]
  },
  { href: '/portfolio', label: 'Portfolio' },
  { href: '/blog', label: 'Blog' },
  { href: '/contact', label: 'Contact' }
];

const ctaLink = { href: '/get-started', label: 'Get Started' };
---

<header class="layout-header">
  <div class="layout-container">
    <div class="header-content">
      <!-- Logo -->
      <div class="header-logo">
        <LogoPrimary />
      </div>

      <!-- Desktop Navigation -->
      <nav class="header-nav-desktop" aria-label="Main navigation">
        <ul class="nav-list">
          {navLinks.map((link) => (
            <li class="nav-item" data-dropdown={link.dropdown ? 'true' : 'false'}>
              <a 
                href={link.href} 
                class="nav-link"
                aria-haspopup={link.dropdown ? 'true' : 'false'}
                aria-expanded="false"
              >
                {link.label}
                {link.dropdown && (
                  <Icon name="chevron-down" size="sm" class="nav-dropdown-icon" />
                )}
              </a>
              
              {link.dropdown && (
                <div class="nav-dropdown" role="menu">
                  <div class="nav-dropdown-content">
                    {link.dropdown.map((item) => (
                      <a 
                        href={item.href} 
                        class="nav-dropdown-link"
                        role="menuitem"
                      >
                        <Icon name={item.icon} size="sm" class="nav-dropdown-link-icon" />
                        <span>{item.label}</span>
                      </a>
                    ))}
                  </div>
                </div>
              )}
            </li>
          ))}
        </ul>
      </nav>

      <!-- Desktop Actions -->
      <div class="header-actions-desktop">
        <ThemeToggle client:idle />
        <Button 
          href={ctaLink.href}
          variant="primary"
          size="sm"
          class="header-cta-button"
        >
          {ctaLink.label}
        </Button>
      </div>

      <!-- Mobile Menu Button -->
      <button 
        class="header-mobile-toggle"
        aria-label="Toggle mobile menu"
        aria-expanded="false"
        data-mobile-menu-toggle
      >
        <Icon name="menu" size="md" class="mobile-menu-icon" />
        <Icon name="x" size="md" class="mobile-menu-close-icon" />
      </button>
    </div>

    <!-- Mobile Navigation -->
    <nav class="header-nav-mobile" aria-label="Mobile navigation" data-mobile-menu>
      <div class="mobile-nav-content">
        <ul class="mobile-nav-list">
          {navLinks.map((link) => (
            <li class="mobile-nav-item">
              <a href={link.href} class="mobile-nav-link">
                {link.label}
              </a>
              
              {link.dropdown && (
                <div class="mobile-nav-dropdown">
                  {link.dropdown.map((item) => (
                    <a href={item.href} class="mobile-nav-dropdown-link">
                      <Icon name={item.icon} size="sm" class="mobile-nav-dropdown-icon" />
                      <span>{item.label}</span>
                    </a>
                  ))}
                </div>
              )}
            </li>
          ))}
        </ul>
        
        <div class="mobile-nav-actions">
          <ThemeToggle client:idle />
          <Button 
            href={ctaLink.href}
            variant="primary"
            size="md"
            class="mobile-cta-button"
          >
            {ctaLink.label}
          </Button>
        </div>
      </div>
    </nav>
  </div>
</header>

<style>
  /* Header Layout */
  .layout-header {
    position: sticky;
    top: 0;
    z-index: var(--z-header);
    background: var(--surface-primary);
    border-bottom: 1px solid var(--border-subtle);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    overflow: hidden; /* Fix overflow issues */
    width: 100%;
    max-width: 100vw; /* Prevent horizontal overflow */
  }

  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: var(--header-height);
    gap: var(--space-6);
    max-width: 100%;
    overflow: hidden; /* Prevent content overflow */
    padding: 0 var(--space-4);
  }

  /* Logo */
  .header-logo {
    flex-shrink: 0;
    z-index: var(--z-header-logo);
  }

  /* Desktop Navigation */
  .header-nav-desktop {
    display: none;
    flex: 1;
    justify-content: center;
    max-width: calc(100% - 200px); /* Reserve space for logo and actions */
    overflow: hidden; /* Prevent nav overflow */
  }

  .nav-list {
    display: flex;
    align-items: center;
    gap: var(--space-8);
    list-style: none;
    margin: 0;
    padding: 0;
    flex-wrap: nowrap; /* Prevent wrapping */
    overflow: hidden; /* Handle overflow gracefully */
  }

  .nav-item {
    position: relative;
    flex-shrink: 0; /* Prevent items from shrinking too much */
    min-width: 0; /* Allow text truncation if needed */
  }

  .nav-link {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-3);
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
    font-size: var(--font-size-sm);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .nav-link:hover,
  .nav-link:focus {
    color: var(--text-primary);
    background: var(--surface-secondary);
  }

  .nav-dropdown-icon {
    transition: transform var(--transition-fast);
  }

  .nav-item[data-dropdown="true"]:hover .nav-dropdown-icon,
  .nav-item[data-dropdown="true"]:focus-within .nav-dropdown-icon {
    transform: rotate(180deg);
  }

  /* Dropdown */
  .nav-dropdown {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-top: var(--space-2);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-fast);
    z-index: var(--z-dropdown);
  }

  .nav-item:hover .nav-dropdown,
  .nav-item:focus-within .nav-dropdown {
    opacity: 1;
    visibility: visible;
  }

  .nav-dropdown-content {
    background: var(--surface-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-2);
    box-shadow: var(--shadow-lg);
    min-width: 200px;
  }

  .nav-dropdown-link {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3);
    color: var(--text-secondary);
    text-decoration: none;
    font-size: var(--font-size-sm);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .nav-dropdown-link:hover,
  .nav-dropdown-link:focus {
    color: var(--text-primary);
    background: var(--surface-secondary);
  }

  .nav-dropdown-link-icon {
    color: var(--text-tertiary);
  }

  /* Desktop Actions */
  .header-actions-desktop {
    display: none;
    align-items: center;
    gap: var(--space-4);
    flex-shrink: 0;
  }

  /* Mobile Menu Toggle */
  .header-mobile-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    position: relative;
    z-index: var(--z-header-toggle);
  }

  .header-mobile-toggle:hover,
  .header-mobile-toggle:focus {
    color: var(--text-primary);
    background: var(--surface-secondary);
  }

  .mobile-menu-close-icon {
    display: none;
  }

  .header-mobile-toggle[aria-expanded="true"] .mobile-menu-icon {
    display: none;
  }

  .header-mobile-toggle[aria-expanded="true"] .mobile-menu-close-icon {
    display: block;
  }

  /* Mobile Navigation */
  .header-nav-mobile {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--surface-primary);
    border-bottom: 1px solid var(--border-subtle);
    box-shadow: var(--shadow-lg);
    z-index: var(--z-mobile-menu);
    max-height: calc(100vh - var(--header-height)); /* Prevent viewport overflow */
    overflow-y: auto; /* Allow scrolling if content is too tall */
  }

  .header-nav-mobile[data-mobile-menu="open"] {
    display: block;
  }

  .mobile-nav-content {
    padding: var(--space-6);
  }

  .mobile-nav-list {
    list-style: none;
    margin: 0;
    padding: 0;
    margin-bottom: var(--space-6);
  }

  .mobile-nav-item {
    margin-bottom: var(--space-2);
  }

  .mobile-nav-link {
    display: block;
    padding: var(--space-4);
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
    font-size: var(--font-size-base);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .mobile-nav-link:hover,
  .mobile-nav-link:focus {
    color: var(--text-primary);
    background: var(--surface-secondary);
  }

  .mobile-nav-dropdown {
    margin-top: var(--space-2);
    margin-left: var(--space-4);
    padding-left: var(--space-4);
    border-left: 2px solid var(--border-subtle);
  }

  .mobile-nav-dropdown-link {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3);
    color: var(--text-tertiary);
    text-decoration: none;
    font-size: var(--font-size-sm);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .mobile-nav-dropdown-link:hover,
  .mobile-nav-dropdown-link:focus {
    color: var(--text-secondary);
    background: var(--surface-secondary);
  }

  .mobile-nav-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding-top: var(--space-6);
    border-top: 1px solid var(--border-subtle);
  }

  /* Responsive Design */
  @media (max-width: 767px) {
    .header-content {
      padding: 0 var(--space-3); /* Reduce padding on mobile */
      gap: var(--space-4); /* Reduce gap on mobile */
    }
    
    .header-logo {
      font-size: 0.9rem; /* Slightly smaller logo on mobile */
    }
  }

  @media (min-width: 768px) {
    .header-nav-desktop {
      display: flex;
    }

    .header-actions-desktop {
      display: flex;
    }

    .header-mobile-toggle {
      display: none;
    }
    
    .header-content {
      padding: 0 var(--space-6); /* More padding on desktop */
    }
  }

  @media (min-width: 1024px) {
    .nav-list {
      gap: var(--space-10); /* More space between nav items on larger screens */
    }
    
    .header-nav-desktop {
      max-width: calc(100% - 300px); /* More space for actions on desktop */
    }
  }

  @media (min-width: 1280px) {
    .header-content {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 var(--space-8);
    }
  }

  /* Enhanced Focus States */
  .nav-link:focus-visible,
  .nav-dropdown-link:focus-visible,
  .mobile-nav-link:focus-visible,
  .mobile-nav-dropdown-link:focus-visible,
  .header-mobile-toggle:focus-visible {
    outline: 2px solid var(--color-primary-500);
    outline-offset: 2px;
  }

  /* Dark Mode Enhancements */
  @media (prefers-color-scheme: dark) {
    .layout-header {
      background: var(--surface-primary-dark);
      border-bottom-color: var(--border-subtle-dark);
    }

    .nav-dropdown-content {
      background: var(--surface-primary-dark);
      border-color: var(--border-subtle-dark);
      box-shadow: var(--shadow-lg-dark);
    }

    .header-nav-mobile {
      background: var(--surface-primary-dark);
      border-bottom-color: var(--border-subtle-dark);
      box-shadow: var(--shadow-lg-dark);
    }
  }

  /* High Contrast Mode */
  @media (prefers-contrast: high) {
    .layout-header {
      border-bottom-width: 2px;
    }

    .nav-link,
    .nav-dropdown-link,
    .mobile-nav-link,
    .mobile-nav-dropdown-link {
      border: 1px solid transparent;
    }

    .nav-link:hover,
    .nav-link:focus,
    .nav-dropdown-link:hover,
    .nav-dropdown-link:focus,
    .mobile-nav-link:hover,
    .mobile-nav-link:focus,
    .mobile-nav-dropdown-link:hover,
    .mobile-nav-dropdown-link:focus {
      border-color: currentColor;
    }
  }

  /* Reduced Motion */
  @media (prefers-reduced-motion: reduce) {
    .nav-link,
    .nav-dropdown-icon,
    .nav-dropdown,
    .nav-dropdown-link,
    .header-mobile-toggle,
    .mobile-nav-link,
    .mobile-nav-dropdown-link {
      transition: none;
    }
  }

  /* Print Styles */
  @media print {
    .layout-header {
      position: static;
      box-shadow: none;
      border-bottom: 1px solid #000;
    }

    .header-actions-desktop,
    .header-mobile-toggle,
    .header-nav-mobile {
      display: none;
    }

    .header-nav-desktop {
      display: block;
    }

    .nav-list {
      flex-wrap: wrap;
      gap: var(--space-4);
    }

    .nav-dropdown {
      display: none;
    }
  }
</style>

<script>
  // Mobile menu functionality
  function initMobileMenu() {
    const toggleButton = document.querySelector('[data-mobile-menu-toggle]');
    const mobileMenu = document.querySelector('[data-mobile-menu]');
    
    if (!toggleButton || !mobileMenu) return;

    toggleButton.addEventListener('click', () => {
      const isOpen = toggleButton.getAttribute('aria-expanded') === 'true';
      
      toggleButton.setAttribute('aria-expanded', (!isOpen).toString());
      mobileMenu.setAttribute('data-mobile-menu', isOpen ? '' : 'open');
      
      // Prevent body scroll when menu is open
      document.body.style.overflow = isOpen ? '' : 'hidden';
    });

    // Close menu when clicking outside
    document.addEventListener('click', (event) => {
      if (!toggleButton.contains(event.target) && !mobileMenu.contains(event.target)) {
        toggleButton.setAttribute('aria-expanded', 'false');
        mobileMenu.setAttribute('data-mobile-menu', '');
        document.body.style.overflow = '';
      }
    });

    // Close menu on escape key
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        toggleButton.setAttribute('aria-expanded', 'false');
        mobileMenu.setAttribute('data-mobile-menu', '');
        document.body.style.overflow = '';
      }
    });

    // Close menu on window resize
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768) {
        toggleButton.setAttribute('aria-expanded', 'false');
        mobileMenu.setAttribute('data-mobile-menu', '');
        document.body.style.overflow = '';
      }
    });
  }

  // Dropdown functionality
  function initDropdowns() {
    const dropdownItems = document.querySelectorAll('[data-dropdown="true"]');
    
    dropdownItems.forEach(item => {
      const link = item.querySelector('.nav-link');
      const dropdown = item.querySelector('.nav-dropdown');
      
      if (!link || !dropdown) return;

      // Handle keyboard navigation
      link.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          const isExpanded = link.getAttribute('aria-expanded') === 'true';
          link.setAttribute('aria-expanded', (!isExpanded).toString());
        }
      });

      // Handle mouse events
      item.addEventListener('mouseenter', () => {
        link.setAttribute('aria-expanded', 'true');
      });

      item.addEventListener('mouseleave', () => {
        link.setAttribute('aria-expanded', 'false');
      });

      // Handle focus events
      item.addEventListener('focusin', () => {
        link.setAttribute('aria-expanded', 'true');
      });

      item.addEventListener('focusout', (event) => {
        // Only close if focus is moving outside the dropdown
        if (!item.contains(event.relatedTarget)) {
          link.setAttribute('aria-expanded', 'false');
        }
      });
    });
  }

  // Initialize on DOM content loaded
  document.addEventListener('DOMContentLoaded', () => {
    initMobileMenu();
    initDropdowns();
  });

  // Re-initialize on navigation (for SPA-like behavior)
  document.addEventListener('astro:page-load', () => {
    initMobileMenu();
    initDropdowns();
  });
</script>